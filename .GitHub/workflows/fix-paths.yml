name: Auto-fix JSON file paths
on:
  workflow_dispatch:   # run manually from the Actions tab
permissions:
  contents: write

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run path-fix script
        run: |
          mkdir -p scripts
          cat > scripts/fix_paths.js <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const base = path.join(process.cwd(), 'papers');
          const jsonPath = path.join(base, 'papers.json');
          const papers = JSON.parse(fs.readFileSync(jsonPath,'utf8'));

          // gather all pdf files in repo
          function walk(dir){
            const out=[];
            for(const f of fs.readdirSync(dir)){
              const p=path.join(dir,f);
              const st=fs.statSync(p);
              if(st.isDirectory()) out.push(...walk(p));
              else if(f.toLowerCase().endsWith('.pdf')) out.push(p.replace(process.cwd()+path.sep,''));
            }
            return out;
          }
          const all=walk(base);
          console.log('Found',all.length,'PDFs');

          for(const p of papers){
            if(!p.file) continue;
            // normalize both sides
            const wantedName = path.basename(p.file).toLowerCase();
            const match = all.find(f => path.basename(f).toLowerCase()===wantedName);
            if(match){
              if(p.file!==match){
                console.log('Fixing',p.id,':',p.file,'â†’',match);
                p.file=match.replace(/\\/g,'/');
              }
              p.available=true;
            } else {
              p.available=false;
            }
          }

          fs.writeFileSync(jsonPath,JSON.stringify(papers,null,2));
          NODE

          node scripts/fix_paths.js
      - name: Commit updated JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add papers/papers.json
          git commit -m "auto: fix JSON file paths and availability" || echo "No changes"
          git push
