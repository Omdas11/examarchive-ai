<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ExamArchive — Browse</title>
  <style>
    :root{
      --accent:#d32f2f; --header:#0f1113; --bg:#fbfbfd; --card:#fff; --footer:#f3f3f5; --text:#222;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);margin:0}
    header{background:var(--header);padding:14px 20px;color:#fff;display:flex;align-items:center;gap:18px}
    header a{color:#fff;text-decoration:none;font-weight:600}
    .wrap{max-width:1100px;margin:22px auto;padding:0 18px}
    .searchbar{display:flex;gap:12px;margin:16px 0}
    .searchbar input,.searchbar select{padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff;flex:1}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .meta{font-size:13px;color:#666;margin-bottom:8px}
    .title{font-weight:700;margin:6px 0}
    .btn{display:inline-block;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:600}
    .btn-view{background:linear-gradient(90deg,var(--accent),#ff6659);color:#fff}
    .btn-download{border:1px solid #ddd;color:var(--accent);background:#fff;margin-left:8px}
    footer{max-width:1100px;margin:28px auto;padding:18px;background:var(--footer);text-align:center;color:#666}
    .small{font-size:13px}
    code{background:#f4f4f6;padding:2px 6px;border-radius:4px;font-size:12px}
    .notice{padding:10px;border-radius:8px;background:#fff6f6;border:1px solid #ffd6d6;color:#7a1a1a}
  </style>
</head>
<body>
  <header>
    <a href="index.html" style="font-size:20px">ExamArchive</a>
    <nav style="margin-left:10px">
      <a href="browse.html">Browse</a> · <a href="collection.html">Collection</a> · <a href="upload.html">Upload</a> · <a href="about.html">About</a>
    </nav>
  </header>

  <main class="wrap">
    <h1>Browse papers</h1>
    <p class="small">Search, filter and preview uploaded papers (data from <code>./papers/papers.json</code>).</p>

    <div class="searchbar">
      <input id="q" placeholder="Search by title, course code, year, subject..." />
      <select id="yearFilter"><option value="">All years</option></select>
      <select id="typeFilter"><option value="">All types</option><option>HCC</option><option>SEC</option><option>General</option></select>
    </div>

    <div id="list" class="grid"></div>

    <div id="error" style="margin-top:18px;display:none">
      <div class="notice">Could not load <code>./papers/papers.json</code>. Check the file exists and is valid JSON.</div>
    </div>
  </main>

  <footer>
    <div>Made with ❤️ · ExamArchive</div>
  </footer>

  <script>
    const JSON_PATH = './papers/papers.json';
    let PAPERS = [];

    const listEl = document.getElementById('list');
    const errEl = document.getElementById('error');
    const qEl = document.getElementById('q');
    const yearFilter = document.getElementById('yearFilter');
    const typeFilter = document.getElementById('typeFilter');

    // fill year dropdown from available years
    function fillYearOptions(arr){
      const years = Array.from(new Set(arr.map(p=>{
        // try to extract year from meta or title or filename
        const fromMeta = (p.meta||'').match(/\\b(19|20)\\d{2}\\b/);
        if(fromMeta) return fromMeta[0];
        const fromTitle = (p.title||'').match(/\\b(19|20)\\d{2}\\b/);
        if(fromTitle) return fromTitle[0];
        const fromFile = (p.file||'').match(/\\b(19|20)\\d{2}\\b/);
        if(fromFile) return fromFile[0];
        return null;
      }).filter(Boolean)));
      years.sort((a,b)=>b-a);
      years.forEach(y=>{
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        yearFilter.appendChild(opt);
      });
    }

    function render(items){
      if(!items || items.length===0){
        listEl.innerHTML = '<div class="small">No papers found.</div>'; return;
      }
      listEl.innerHTML = items.map(p=>`
        <article class="card">
          <div class="meta">${escapeHtml(p.meta||'')}</div>
          <div class="title">${escapeHtml(p.title||p.file||'Untitled')}</div>
          <div style="margin-top:10px">
            <a class="btn btn-view" href="${encodeURI(p.file)}" target="_blank" rel="noopener">Preview</a>
            <a class="btn btn-download" href="${encodeURI(p.file)}" download>Download</a>
          </div>
        </article>
      `).join('');
    }

    function doFilter(){
      const term = qEl.value.trim().toLowerCase();
      const yr = yearFilter.value;
      const type = typeFilter.value;
      const out = PAPERS.filter(p=>{
        if(yr && !((p.meta||'') + ' ' + (p.title||'') + ' ' + (p.file||'')).includes(yr)) return false;
        if(type && !(p.meta||'').includes(type)) return false;
        if(!term) return true;
        const hay = ((p.title||'') + ' ' + (p.meta||'') + ' ' + (p.file||'')).toLowerCase();
        return hay.includes(term);
      });
      render(out);
    }

    qEl.addEventListener('input', doFilter);
    yearFilter.addEventListener('change', doFilter);
    typeFilter.addEventListener('change', doFilter);

    // If page opened with ?q=PHSHCC-201T etc, prefill search
    function applyQueryParam(){
      const params = new URLSearchParams(location.search);
      const q = params.get('q');
      if(q){ qEl.value = q; }
    }

    fetch(JSON_PATH).then(r=>{
      if(!r.ok) throw new Error('Failed to fetch');
      return r.json();
    }).then(data=>{
      PAPERS = Array.isArray(data) ? data : (data.papers||[]);
      fillYearOptions(PAPERS);
      applyQueryParam();
      doFilter();
    }).catch(e=>{
      console.error(e);
      errEl.style.display = 'block';
    });

    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"'`=\/]/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch]));
    }
  </script>
</body>
</html>