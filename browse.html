<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browse — ExamArchive</title>

  <!-- Use the shared site stylesheet (relative path) -->
  <link rel="stylesheet" href="style/common.css">

  <style>
    /* Small local helpers that shouldn't conflict with common.css */
    .container { max-width:1100px; margin:0 auto; padding:0 1rem; }
    .controls { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; margin-bottom:1rem; }
    .controls input[type="search"]{ padding:0.5rem; min-width:220px; }
    .controls select, .controls button{ padding:0.45rem 0.6rem; }
    .view-toggle{ display:flex; gap:0.25rem; }
    .cards-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:1rem; }
    .card{ border:1px solid #e6e6e6; padding:0.8rem; border-radius:8px; display:flex; flex-direction:column; gap:0.5rem; background:#fff; }
    .table-wrap{ overflow:auto; background:#fff; border-radius:6px; border:1px solid #eee; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:0.6rem 0.75rem; border-bottom:1px solid #f0f0f0; text-align:left; font-size:0.95rem; }
    th { background:transparent; font-weight:700; }
    .badge{ padding:0.18rem 0.5rem; border-radius:999px; font-size:0.82rem; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:80; }
    .modal{ background:#fff; padding:1rem; border-radius:10px; width:94%; max-width:420px; box-shadow:0 8px 30px rgba(0,0,0,0.2); }
    .sr-only{ position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
    @media (max-width:640px) { .controls input[type="search"]{ min-width:140px; } }
  </style>
</head>
<body>
  <!-- Header (match your site header style) -->
  <header class="site-header" style="border-bottom:1px solid #eee;">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:0.8rem 0;">
      <a class="brand" href="index.html" style="font-weight:700;text-decoration:none;">ExamArchive</a>
      <nav class="main-nav" aria-label="Main navigation" style="display:flex;gap:0.8rem;">
        <a href="index.html">Home</a>
        <a href="browse.html" aria-current="page">Browse</a>
        <a href="about.html">About</a>
        <a href="upload.html">Upload</a>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:1.25rem 0 4rem;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:0.6rem;">
      <h1 style="margin:0;font-size:2rem;">Browse Papers</h1>
      <div style="display:flex;gap:0.5rem;align-items:center">
        <button id="openProgramModal" class="btn">Switch Program</button>
        <div class="view-toggle" role="toolbar" aria-label="View toggle">
          <button id="gridViewBtn" class="btn">Grid</button>
          <button id="tableViewBtn" class="btn">Table</button>
        </div>
      </div>
    </div>

    <!-- Controls: Search + Filters -->
    <div class="controls" role="region" aria-label="Search and filters">
      <input id="searchInput" type="search" placeholder="Search by paper code, name or year" aria-label="Search papers">

      <select id="yearFilter" aria-label="Filter by year">
        <option value="">All years</option>
      </select>

      <select id="availabilityFilter" aria-label="Filter by availability">
        <option value="">All</option>
        <option value="true">Available</option>
        <option value="false">Not available</option>
      </select>

      <select id="programFilter" aria-label="Filter by program">
        <option value="">All programs</option>
        <option value="CBCS">CBCS</option>
        <option value="FYUG">FYUG</option>
      </select>

      <button id="clearFilters" class="btn">Clear</button>
    </div>

    <!-- Grid view -->
    <div id="gridContainer" class="cards-grid" hidden></div>

    <!-- Table view -->
    <div id="tableContainer" class="table-wrap" hidden>
      <table id="papersTable" aria-describedby="papers-table">
        <thead>
          <tr>
            <th>SL. No.</th>
            <th>Paper Code</th>
            <th>Paper Name</th>
            <th>Availability</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p id="statusMsg" style="margin-top:0.8rem;color:#666"></p>
  </main>

  <!-- Modal: Switch between CBCS and FYUG -->
  <div id="programModal" class="modal-backdrop" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="progTitle">
      <h3 id="progTitle" style="margin-top:0">Choose Program</h3>
      <p style="margin:0.3rem 0 0.8rem;color:#555">Select which program you want to browse (this will filter the list).</p>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
        <button data-prog="CBCS" class="btn chooseProg">CBCS</button>
        <button data-prog="FYUG" class="btn chooseProg">FYUG</button>
        <button id="progModalAll" class="btn">All</button>
      </div>
      <div style="text-align:right;margin-top:0.6rem">
        <button id="closeProgramModal" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // --- Config & DOM refs ---
    const papersJsonPath = 'papers/papers.json'; // relative path (works on GitHub Pages project site)
    const gridContainer = document.getElementById('gridContainer');
    const tableContainer = document.getElementById('tableContainer');
    const papersTableBody = document.querySelector('#papersTable tbody');
    const statusMsg = document.getElementById('statusMsg');

    const searchInput = document.getElementById('searchInput');
    const yearFilter = document.getElementById('yearFilter');
    const availabilityFilter = document.getElementById('availabilityFilter');
    const programFilter = document.getElementById('programFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');

    const gridViewBtn = document.getElementById('gridViewBtn');
    const tableViewBtn = document.getElementById('tableViewBtn');

    const programModal = document.getElementById('programModal');
    const openProgramModal = document.getElementById('openProgramModal');
    const closeProgramModal = document.getElementById('closeProgramModal');

    let papers = [];
    let view = localStorage.getItem('browseView') || 'table';
    let selectedProgram = localStorage.getItem('selectedProgram') || '';

    // --- Helpers ---
    function setView(v){
      view = v;
      localStorage.setItem('browseView', v);
      if(v === 'grid'){ gridContainer.hidden = false; tableContainer.hidden = true; }
      else { gridContainer.hidden = true; tableContainer.hidden = false; }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

    // --- Modal handlers ---
    openProgramModal.addEventListener('click', ()=> programModal.hidden = false);
    closeProgramModal.addEventListener('click', ()=> programModal.hidden = true);
    document.getElementById('progModalAll').addEventListener('click', ()=> {
      selectedProgram = ''; localStorage.removeItem('selectedProgram');
      programFilter.value = ''; programModal.hidden = true; render();
    });
    document.querySelectorAll('.chooseProg').forEach(btn => btn.addEventListener('click', e => {
      selectedProgram = e.target.dataset.prog;
      localStorage.setItem('selectedProgram', selectedProgram);
      programFilter.value = selectedProgram;
      programModal.hidden = true;
      render();
    }));

    // Close modal by clicking backdrop
    programModal.addEventListener('click', (e) => {
      if (e.target === programModal) programModal.hidden = true;
    });
    // Close modal with ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !programModal.hidden) programModal.hidden = true;
    });

    // --- Fetch & normalize data ---
    async function loadPapers(){
      try {
        const res = await fetch(papersJsonPath + '?_=' + Date.now());
        if(!res.ok) throw new Error('Failed to load papers.json — status ' + res.status);
        const raw = await res.json();

        // Normalize items into a stable shape
        papers = raw.map((p, idx) => {
          const code = p.code || p.paperCode || p.paper_code || p.file || 'UNKNOWN';
          const name = p.name || p.title || p.paperName || p.paper_name || '';
          const year = p.year || p.date || '';
          const program = (p.program || p.type || p.scheme || '').toString();
          // compute normalized url and tolerate common typo in folder name
          let rawUrl = (p.url || p.path) || (p.file ? ('papers/' + p.file) : '');
          if (rawUrl && rawUrl.includes('/CBSC/')) {
            rawUrl = rawUrl.replace(/\/CBSC\//g, '/CBCS/');
          }
          // if someone wrote 'CBSC' without slashes
          if (rawUrl && rawUrl.includes('CBSC')) {
            rawUrl = rawUrl.replace(/CBSC/g, 'CBCS');
          }
          // ensure relative-style path (do not forcibly add leading slash)
          const available = (p.available === true || p.availability === true || String(p.available).toLowerCase() === 'true' || String(p.available).toLowerCase() === 'yes');
          return {
            _id: idx + 1,
            code, name, year, program, available: !!available, url: rawUrl
          };
        });

        populateYearFilter();
        if(selectedProgram) programFilter.value = selectedProgram;
        setView(view);
        render();
      } catch (err) {
        statusMsg.textContent = 'Error: ' + err.message;
      }
    }

    function populateYearFilter(){
      const years = Array.from(new Set(papers.map(p=>p.year).filter(Boolean))).sort((a,b)=> (b - a));
      yearFilter.innerHTML = '<option value="">All years</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
    }

    // --- Filtering & rendering ---
    function applyFilters(){
      const q = (searchInput.value || '').trim().toLowerCase();
      const y = yearFilter.value;
      const av = availabilityFilter.value;
      const prog = programFilter.value || selectedProgram || '';

      return papers.filter(p => {
        if(prog && String(p.program).toLowerCase() !== String(prog).toLowerCase()) return false;
        if(y && String(p.year) !== String(y)) return false;
        if(av !== '' && String(p.available) !== String(av)) return false;
        if(!q) return true;
        return [p.code, p.name, String(p.year), p.program].join(' ').toLowerCase().includes(q);
      });
    }

    function renderGrid(items){
      gridContainer.innerHTML = '';
      if(items.length === 0){
        gridContainer.innerHTML = '<p>No papers found.</p>'; return;
      }
      items.forEach(p => {
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div style="font-weight:600">${escapeHtml(p.code)}</div>
          <div style="font-size:0.95rem;color:#333">${escapeHtml(p.name)}</div>
          <div style="margin-top:auto;display:flex;justify-content:space-between;align-items:center">
            <small style="color:#666">${escapeHtml(p.year)} • ${escapeHtml(p.program)}</small>
            <div style="display:flex;gap:0.35rem">
              <a ${p.url?`href="${p.url}" target="_blank" rel="noopener"`:'href="#" tabindex="-1"'} class="btn">Preview</a>
              <a ${p.url?`href="${p.url}" download`:'href="#" tabindex="-1"'} class="btn">Download</a>
            </div>
          </div>
        `;
        gridContainer.appendChild(card);
      });
    }

    function renderTable(items){
      papersTableBody.innerHTML = '';
      if(items.length === 0){
        papersTableBody.innerHTML = '<tr><td colspan="5">No papers found.</td></tr>'; return;
      }
      items.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(p.code)}</td>
          <td>${escapeHtml(p.name)}</td>
          <td>${p.available ? '<span class="badge" style="background:#e6ffed;color:#046a18">Available</span>' : '<span class="badge" style="background:#fff3f2;color:#9b1c1c">Not available</span>'}</td>
          <td>
            <a ${p.url?`href="${p.url}" target="_blank" rel="noopener"`:'href="#" tabindex="-1"'} class="btn">Preview</a>
            <a ${p.url?`href="${p.url}" download`:'href="#" tabindex="-1"'} class="btn">Download</a>
          </td>
        `;
        papersTableBody.appendChild(tr);
      });
    }

    function render(){
      const items = applyFilters();
      statusMsg.textContent = `Showing ${items.length} of ${papers.length} papers`;
      if(view === 'grid') renderGrid(items); else renderTable(items);
    }

    // --- Events ---
    [searchInput, yearFilter, availabilityFilter, programFilter].forEach(el => el.addEventListener('input', render));
    clearFiltersBtn.addEventListener('click', () => {
      searchInput.value = ''; yearFilter.value = ''; availabilityFilter.value = ''; programFilter.value = '';
      selectedProgram = ''; localStorage.removeItem('selectedProgram'); render();
    });

    gridViewBtn.addEventListener('click', () => setView('grid'));
    tableViewBtn.addEventListener('click', () => setView('table'));

    // --- Init ---
    (function init(){
      setView(view);
      if(selectedProgram) programFilter.value = selectedProgram;
      loadPapers();
    })();
  </script>
</body>
</html>