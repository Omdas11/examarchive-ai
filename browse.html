<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Browse Papers — ExamArchive</title>
<style>
  :root{
    --accent:#d32f2f; /* your red */
    --muted:#6b7280;
    --bg:#f7f7f8;
    --card:#ffffff;
    --radius:12px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{margin:0;background:var(--bg);color:#111;padding:18px}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{color:var(--accent);margin:0;font-size:1.3rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  input[type="search"], select{padding:10px;border-radius:10px;border:1px solid #ddd;min-width:160px}
  button{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:18px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;gap:10px;align-items:flex-start}
  .thumb{width:76px;height:96px;border-radius:6px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;overflow:hidden}
  .meta{flex:1}
  .title{font-weight:700;margin:0 0 6px 0;color:var(--accent);font-size:14px}
  .sub{font-size:13px;color:var(--muted);margin-bottom:8px}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:12px;padding:5px 8px;border-radius:999px;border:1px solid #eee;background:#fafafa}
  .empty{padding:30px;text-align:center;color:var(--muted)}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  @media (max-width:520px){ .controls{flex-direction:column;align-items:stretch} input[type="search"],select{width:100%} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Browse — Papers</h1>
      <div style="font-size:13px;color:var(--muted)">Source: <strong>mains/paper.json</strong></div>
    </div>
    <div style="text-align:right">
      <a href="/upload.html" style="color:var(--accent);text-decoration:none;font-size:13px">Upload</a>
    </div>
  </header>

  <div class="controls" style="margin-top:14px">
    <input id="q" type="search" placeholder="Search by title, code, tags, university..." />
    <select id="filter-year"><option value="">All years</option></select>
    <select id="filter-level"><option value="">All levels</option></select>
    <select id="filter-stream"><option value="">All streams</option></select>
    <select id="filter-type"><option value="">All types</option></select>
    <select id="filter-subject"><option value="">All subjects</option></select>
    <select id="sort"><option value="new">Newest</option><option value="old">Oldest</option><option value="title">Title</option></select>
    <button id="clear">Clear</button>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>
  <div id="empty" class="empty" style="display:none">No matching papers.</div>

  <footer>
    Tip: include paper code and 4-digit year in filename (e.g., <code>2023-PHSHCC-201T.pdf</code>).
  </footer>
</div>

<script>
(async function(){
  // Fetch mains/paper.json — supports array or {papers:[...]}
  let resp;
  try { resp = await fetch('/mains/paper.json'); } catch(e){ showError('Failed to fetch mains/paper.json'); return; }
  if(!resp.ok){ showError('Could not load mains/paper.json (404).'); return; }
  const raw = await resp.json();
  const items = Array.isArray(raw) ? raw : (raw.papers || []);
  const papers = items.map(normalize);

  // DOM refs
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const q = document.getElementById('q');
  const yearSel = document.getElementById('filter-year');
  const levelSel = document.getElementById('filter-level');
  const streamSel = document.getElementById('filter-stream');
  const typeSel = document.getElementById('filter-type');
  const subjectSel = document.getElementById('filter-subject');
  const sortSel = document.getElementById('sort');
  const clearBtn = document.getElementById('clear');

  // populate filters
  populateFilter(yearSel, unique(papers.map(p=>p.year)).sort((a,b)=>b-a));
  populateFilter(levelSel, unique(papers.map(p=>p.level)));
  populateFilter(streamSel, unique(papers.map(p=>p.stream)));
  populateFilter(typeSel, unique(papers.map(p=>p.paper_type)));
  populateFilter(subjectSel, unique(papers.map(p=>p.subject)));

  // initial render
  render(papers);

  // events
  [q, yearSel, levelSel, streamSel, typeSel, subjectSel, sortSel].forEach(el => el.addEventListener('input', doSearch));
  clearBtn.addEventListener('click', ()=>{ q.value=''; yearSel.value=''; levelSel.value=''; streamSel.value=''; typeSel.value=''; subjectSel.value=''; sortSel.value='new'; doSearch(); });

  function showError(msg){
    document.getElementById('grid').innerHTML = '<div class="empty">'+msg+'</div>';
  }

  function normalize(it){
    // ensure fields exist and standardize
    const year = (it.year || (it.date||'').slice(0,4) || '').toString();
    return {
      id: it.id || (it.paper_name || (it.file||'').split('/').pop().split('.')[0]) ,
      title: it.title || it.paper_name || it.id || 'Untitled',
      file: (it.file || '').replace(/\\/g,'/'),
      year: year || '',
      level: (it.level || it.levels || it.level_name || '').toString(),
      stream: it.stream || it.stream_name || '',
      paper_type: it.paper_type || it.type || it.paperType || '',
      subject: it.subject || '',
      paper_name: it.paper_name || it.id || '',
      university: it.university || it.college || '',
      tags: Array.isArray(it.tags) ? it.tags.map(t=>t+'') : (typeof it.tags === 'string' ? it.tags.split(/[,|;]/).map(s=>s.trim()) : [])
    };
  }

  function populateFilter(sel, values){
    const cleaned = values.filter(v=>v && v!='' && v!=undefined).map(v=>v+'');
    const uniq = unique(cleaned).sort();
    uniq.forEach(v => sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
  }

  function doSearch(){ 
    const qv = q.value.trim().toLowerCase();
    const yr = yearSel.value;
    const lvl = levelSel.value;
    const strm = streamSel.value;
    const typ = typeSel.value;
    const subj = subjectSel.value;
    let list = papers.filter(p=>{
      if(yr && p.year!==yr) return false;
      if(lvl && (p.level||'')!==lvl) return false;
      if(strm && (p.stream||'')!==strm) return false;
      if(typ && (p.paper_type||'')!==typ) return false;
      if(subj && (p.subject||'')!==subj) return false;
      if(!qv) return true;
      const hay = (p.title+' '+p.paper_name+' '+(p.tags||[]).join(' ')+' '+p.university+' '+p.id+' '+p.subject).toLowerCase();
      return hay.includes(qv);
    });
    // sort
    const sortv = sortSel.value;
    list.sort((a,b)=>{
      if(sortv==='new') return (parseInt(b.year||0) - parseInt(a.year||0));
      if(sortv==='old') return (parseInt(a.year||0) - parseInt(b.year||0));
      if(sortv==='title') return (a.title||'').localeCompare(b.title||'');
      return 0;
    });
    render(list);
  }

  function render(list){
    grid.innerHTML = '';
    if(!list.length){ empty.style.display='block'; return; } else { empty.style.display='none'; }
    list.forEach(p=>{
      const thumb = `/assets/thumbnails/${p.id}.png`;
      const thumbHtml = `<div class="thumb"><img src="${thumb}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'; this.parentElement.innerText='PDF'"></div>`;
      const tagsHtml = (p.tags||[]).slice(0,6).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
      const fileLink = p.file || guessFilePath(p);
      const titleLink = `<a href="${fileLink}" target="_blank" rel="noopener">${escapeHtml(p.title)}</a>`;
      const metaHtml = `<div class="sub">${escapeHtml(p.subject||'')} · ${escapeHtml(p.paper_type||'')} · ${escapeHtml(p.level||'')} · ${escapeHtml(p.university||'')} · ${escapeHtml(p.year||'')}</div>`;
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `${thumbHtml}<div class="meta"><div class="title">${titleLink}</div>${metaHtml}<div class="tags">${tagsHtml}</div></div>`;
      grid.appendChild(card);
    });
  }

  function guessFilePath(p){
    // fallback guess: /papers/<LEVEL>/<STREAM>/<TYPE>/<SUBJECT>/<YEAR>-<ID>.pdf
    const lvl = p.level || 'CBCS';
    const stream = p.stream || 'Science';
    const type = p.paper_type || 'HCC';
    const subj = p.subject || 'Physics';
    const idpart = p.id || p.paper_name || '';
    const yr = p.year || '';
    const filename = (yr ? (yr+'-') : '') + idpart + '.pdf';
    return `/papers/${lvl}/${stream}/${type}/${subj}/${filename}`;
  }

  // utilities
  function unique(a){ return [...new Set(a.filter(x=>x!==undefined && x!==null))]; }
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
})();
</script>
</body>
</html>