<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Collection — ExamArchive</title>
  <link rel="stylesheet" href="styles/common.css">
  <style>
    .collection-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .collection-card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 0 rgba(0,0,0,0.04);min-height:72px;display:flex;flex-direction:column;justify-content:space-between}
    .small-muted{font-size:0.9rem;color:#666}
    .col-header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    /* Modal */
    .ea-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999;padding:20px}
    .ea-modal{background:#0f1720;color:#fff;border-radius:10px;max-width:920px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.04)}
    .ea-modal-header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;justify-content:space-between;align-items:center}
    .ea-modal-body{padding:12px 16px;overflow:auto;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    .ea-modal-footer{padding:10px 12px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;justify-content:flex-end}
    .ea-pre{white-space:pre-wrap;font-size:0.95rem;line-height:1.3;color:#e6eef6}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px;border-radius:6px;color:#fff}
    .badge-count{font-size:0.86rem;color:#666;margin-top:6px}
    @media (max-width:480px){ .ea-modal{max-height:92vh;padding-bottom:0} .ea-modal-body{font-size:0.9rem} }
  </style>
</head>
<body>
  <header>
    <nav class="navbar">
      <a class="logo" href="index.html">ExamArchive</a>
      <ul class="nav-links">
        <li><a href="browse.html">Browse</a></li>
        <li><a href="collection.html" class="active">Collection</a></li>
        <li><a href="upload.html">Upload</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <h1>Collections</h1>
    <p class="small-muted">Collections are generated from your papers metadata. If you have no explicit `collection` field, the page will automatically group by subject, type, system, category, or stream.</p>

    <div style="margin-top:12px;background:#fff;padding:12px;border-radius:8px">
      <div class="col-header" style="margin-bottom:10px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="groupBySubject" class="btn">Group by subject</button>
          <button id="groupByType" class="btn">Group by type</button>
          <button id="groupBySystem" class="btn">Group by system</button>
          <button id="groupByCategory" class="btn">Group by category</button>
          <button id="groupByStream" class="btn">Group by stream</button>
        </div>
        <div>
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>
      </div>

      <div id="collectionsArea" style="margin-top:12px"></div>
    </div>
  </main>

  <!-- Modal for listing papers in a collection -->
  <div id="eaModalBackdrop" class="ea-modal-backdrop" role="dialog" aria-hidden="true">
    <div class="ea-modal" role="document" aria-labelledby="eaModalTitle">
      <div class="ea-modal-header">
        <div id="eaModalTitle" style="font-weight:700">Collection</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="eaModalCount" class="badge-count"></div>
          <button id="eaCopyBtn" class="btn-ghost">Copy</button>
          <button id="eaCloseBtn" class="btn-ghost">Close</button>
        </div>
      </div>
      <div class="ea-modal-body">
        <pre id="eaModalPre" class="ea-pre" tabindex="0"></pre>
      </div>
      <div class="ea-modal-footer">
        <button id="eaMoreBtn" class="btn">Show more</button>
        <button id="eaCloseBtn2" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = 'papers/papers.json';
    const collectionsArea = document.getElementById('collectionsArea');
    const eaModalBackdrop = document.getElementById('eaModalBackdrop');
    const eaModalTitle = document.getElementById('eaModalTitle');
    const eaModalPre = document.getElementById('eaModalPre');
    const eaModalCount = document.getElementById('eaModalCount');
    const eaCopyBtn = document.getElementById('eaCopyBtn');
    const eaCloseBtn = document.getElementById('eaCloseBtn');
    const eaCloseBtn2 = document.getElementById('eaCloseBtn2');
    const eaMoreBtn = document.getElementById('eaMoreBtn');

    const FALLBACK_FIELDS = ['collection','subject','type','system','category','stream'];
    const SHOW_LIMIT = 200; // show first N by default in modal

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    async function loadPapers(){
      try{
        const r = await fetch(DATA_URL);
        const papers = await r.json();
        return Array.isArray(papers) ? papers : [];
      }catch(e){
        console.error(e);
        return [];
      }
    }

    function normalizeKey(k){
      if(!k) return 'Unknown';
      return String(k).trim() || 'Unknown';
    }

    function renderCollections(map){
      collectionsArea.innerHTML = '';
      if(Object.keys(map).length === 0){
        collectionsArea.innerHTML = '<div style="padding:12px;color:#666">No collections found. Try grouping by a specific field above.</div>';
        return;
      }
      const grid = document.createElement('div'); grid.className='collection-grid';
      for(const key of Object.keys(map).sort((a,b)=> a.localeCompare(b))){
        const card = document.createElement('div'); card.className='collection-card';
        const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = key;
        const count = document.createElement('div'); count.style.fontSize='0.92rem'; count.style.color='#666'; count.textContent = map[key].length + ' papers';
        const actions = document.createElement('div'); actions.style.marginTop='8px';
        const seeBtn = document.createElement('button'); seeBtn.className='btn'; seeBtn.textContent='Open';
        seeBtn.addEventListener('click', ()=> showCollectionModal(key, map[key]));
        actions.appendChild(seeBtn);
        card.appendChild(title); card.appendChild(count); card.appendChild(actions);
        grid.appendChild(card);
      }
      collectionsArea.appendChild(grid);
    }

    function buildListText(items){
      // Build readable multiline text; convert literal "\n" sequences to real newlines
      const arr = items.map(p => {
        const id = p.id || '';
        const title = p.title || '';
        const year = p.year || '';
        return `${id} — ${title} (${year})`;
      });
      return arr.join('\\n').replace(/\\\\n/g,'\\\\n').replace(/\\n/g, '\n'); // ensure literal \n becomes newline
    }

    function showCollectionModal(key, items){
      const total = items.length;
      eaModalTitle.textContent = key;
      eaModalCount.textContent = total + ' papers';
      const lines = items.map(p => `${p.id || ''} — ${p.title || ''} (${p.year || ''})`);
      // convert any literal "\n" inside values to real newlines
      const normalized = lines.map(l => l.replace(/\\\\n/g, '\\n').replace(/\\n/g, '\n'));
      const initial = normalized.slice(0, SHOW_LIMIT).join('\n');
      const moreCount = total - SHOW_LIMIT;
      eaModalPre.textContent = initial + (moreCount > 0 ? `\n\n...and ${moreCount} more. Tap "Show more" to reveal all.` : '');
      eaMoreBtn.style.display = moreCount > 0 ? 'inline-block' : 'none';
      // store full text on element dataset for show-more and copy
      eaModalPre.dataset.full = normalized.join('\n');
      eaModalBackdrop.style.display = 'flex';
      eaModalBackdrop.setAttribute('aria-hidden','false');
      // focus for a11y
      setTimeout(()=> eaModalPre.focus(), 120);
    }

    eaCloseBtn.addEventListener('click', closeModal);
    eaCloseBtn2.addEventListener('click', closeModal);
    eaCopyBtn.addEventListener('click', ()=> {
      const txt = eaModalPre.dataset.full || eaModalPre.textContent || '';
      navigator.clipboard.writeText(txt).then(()=> alert('Copied to clipboard')).catch(() => alert('Copy failed'));
    });

    eaMoreBtn.addEventListener('click', ()=> {
      eaModalPre.textContent = eaModalPre.dataset.full || eaModalPre.textContent;
      eaMoreBtn.style.display = 'none';
    });

    function closeModal(){
      eaModalBackdrop.style.display = 'none';
      eaModalBackdrop.setAttribute('aria-hidden','true');
    }

    async function groupByFields(fieldNames){
      const papers = await loadPapers();
      const map = {};
      for(const p of papers){
        let value = null;
        if(Array.isArray(fieldNames)){
          for(const f of fieldNames){
            if(p[f]) { value = p[f]; break; }
          }
        } else {
          value = p[fieldNames];
        }

        if(!value){
          for(const ff of FALLBACK_FIELDS){
            if(p[ff]) { value = p[ff]; break; }
          }
        }

        const key = normalizeKey(value);
        if(Array.isArray(value)){
          for(const v of value){
            const kk = normalizeKey(v);
            (map[kk] = map[kk] || []).push(p);
          }
        } else {
          (map[key] = map[key] || []).push(p);
        }
      }
      renderCollections(map);
    }

    document.getElementById('groupBySubject').addEventListener('click', ()=> groupByFields('subject'));
    document.getElementById('groupByType').addEventListener('click', ()=> groupByFields('type'));
    document.getElementById('groupBySystem').addEventListener('click', ()=> groupByFields('system'));
    document.getElementById('groupByCategory').addEventListener('click', ()=> groupByFields('category'));
    document.getElementById('groupByStream').addEventListener('click', ()=> groupByFields('stream'));

    document.getElementById('refreshBtn').addEventListener('click', async ()=>{
      collectionsArea.innerHTML = '<div style="padding:12px">Refreshing…</div>';
      const papers = await loadPapers();
      if(papers.length === 0) collectionsArea.innerHTML = '<div style="padding:12px;color:#666">No papers found in papers/papers.json</div>';
      else collectionsArea.innerHTML = '<div style="padding:12px;color:#666">Use the buttons to group papers into collections.</div>';
    });

    // initial load
    (async ()=>{
      const papers = await loadPapers();
      if(papers.length === 0){
        collectionsArea.innerHTML = '<div style="padding:12px;color:#666">No papers found in papers/papers.json</div>';
        return;
      }
      const explicit = papers.filter(p => p.collection);
      if(explicit.length){
        const map = {};
        for(const p of explicit){
          const colVal = p.collection || 'Unknown';
          if(Array.isArray(colVal)){
            for(const v of colVal){ (map[normalizeKey(v)] = map[normalizeKey(v)] || []).push(p); }
          } else {
            (map[normalizeKey(colVal)] = map[normalizeKey(colVal)] || []).push(p);
          }
        }
        renderCollections(map);
        return;
      }
      groupByFields(['subject','type','system','category','stream']);
    })();
  </script>
</body>
</html>