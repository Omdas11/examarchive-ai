<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Collection — ExamArchive</title>
  <link rel="stylesheet" href="styles/common.css">
  <style>
    .collection-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .collection-card{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 0 rgba(0,0,0,0.04)}
    .small-muted{font-size:0.9rem;color:#666}
  </style>
</head>
<body>
  <header>
    <nav class="navbar">
      <a class="logo" href="index.html">ExamArchive</a>
      <ul class="nav-links">
        <li><a href="browse.html">Browse</a></li>
        <li><a href="collection.html" class="active">Collection</a></li>
        <li><a href="upload.html">Upload</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <h1>Collections</h1>
    <p class="small-muted">Collections are generated from your papers metadata. If you have no explicit collections, the page will group by type automatically.</p>

    <div style="margin-top:12px;background:#fff;padding:12px;border-radius:8px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="groupBySubject" class="btn">Group by subject</button>
        <button id="groupByType" class="btn">Group by type</button>
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>

      <div id="collectionsArea" style="margin-top:12px"></div>
    </div>
  </main>

  <script>
    const DATA_URL = 'papers/papers.json';
    const collectionsArea = document.getElementById('collectionsArea');

    async function loadPapers(){
      try{
        const r = await fetch(DATA_URL);
        const papers = await r.json();
        return Array.isArray(papers) ? papers : [];
      }catch(e){
        return [];
      }
    }

    function renderCollections(map){
      collectionsArea.innerHTML = '';
      if(Object.keys(map).length === 0){
        collectionsArea.innerHTML = '<div style="padding:12px;color:#666">No collections found. Try grouping by subject or type.</div>';
        return;
      }
      const grid = document.createElement('div'); grid.className='collection-grid';
      for(const key of Object.keys(map).sort()){
        const card = document.createElement('div'); card.className='collection-card';
        const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = key;
        const count = document.createElement('div'); count.style.fontSize='0.92rem'; count.style.color='#666'; count.textContent = map[key].length + ' papers';
        const seeBtn = document.createElement('button'); seeBtn.className='btn'; seeBtn.textContent='Open';
        seeBtn.addEventListener('click', ()=> {
          const list = map[key].map(p => `${p.id} — ${p.title} (${p.year || ''})`).join('\\n');
          alert(key + '\\n\\n' + list);
        });
        card.appendChild(title); card.appendChild(count); card.appendChild(seeBtn);
        grid.appendChild(card);
      }
      collectionsArea.appendChild(grid);
    }

    async function groupByField(field){
      const papers = await loadPapers();
      const map = {};
      for(const p of papers){
        const val = (p.collection || p[field] || 'Unknown') || 'Unknown';
        if(Array.isArray(val)){
          for(const v of val){ (map[v] = map[v] || []).push(p); }
        } else {
          (map[val] = map[val] || []).push(p);
        }
      }
      renderCollections(map);
    }

    document.getElementById('groupBySubject').addEventListener('click', ()=> groupByField('subject'));
    document.getElementById('groupByType').addEventListener('click', ()=> groupByField('type'));
    document.getElementById('refreshBtn').addEventListener('click', async ()=>{
      collectionsArea.innerHTML = '<div style="padding:12px">Refreshing…</div>';
      const papers = await loadPapers();
      if(papers.length === 0) collectionsArea.innerHTML = '<div style="padding:12px;color:#666">No papers found in papers/papers.json</div>';
      else collectionsArea.innerHTML = '<div style="padding:12px;color:#666">Use the buttons to group papers into collections.</div>';
    });

    // initial load: prefer explicit collection fields, else auto group by type
    (async ()=>{
      const papers = await loadPapers();
      if(papers.length === 0){
        collectionsArea.innerHTML = '<div style="padding:12px;color:#666">No papers found in papers/papers.json</div>';
        return;
      }
      const explicit = papers.filter(p => p.collection);
      if(explicit.length){
        const map = {};
        for(const p of explicit){
          const col = p.collection || 'Unknown';
          (map[col] = map[col] || []).push(p);
        }
        renderCollections(map);
      } else {
        // fallback: group by type automatically so user sees something
        groupByField('type');
      }
    })();
  </script>
</body>
</html>