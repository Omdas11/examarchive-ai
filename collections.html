<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ExamArchive — Collections</title>
  <style>
    :root{--accent:#d32f2f;--header:#0f1113;--bg:#fbfbfd;--card:#fff;--footer:#f3f3f5;--text:#222}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);margin:0}
    header{background:var(--header);padding:12px 18px;color:#fff;display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand a{color:#fff;text-decoration:none;font-weight:700;font-size:18px}
    nav a{color:#fff;text-decoration:none;margin-right:12px;font-weight:600}
    .wrap{max-width:1100px;margin:18px auto;padding:0 18px}
    .grid{display:flex;gap:12px;flex-wrap:wrap}
    .collection-card{background:var(--card);border-radius:10px;padding:14px;width:calc(33% - 8px);min-width:220px;box-shadow:0 6px 16px rgba(0,0,0,0.06)}
    .collection-card h3{margin:6px 0}
    .small{font-size:13px;color:#666}
    @media(max-width:820px){.collection-card{width:48%}}
    @media(max-width:520px){.collection-card{width:100%}}
    footer{max-width:1100px;margin:28px auto;padding:18px;background:var(--footer);text-align:center;color:#666}
    .notice{padding:10px;border-radius:8px;background:#fff6f6;border:1px solid #ffd6d6;color:#7a1a1a}
  </style>
</head>
<body>
  <header>
    <div class="brand"><a href="./index.html">ExamArchive</a></div>
    <nav>
      <a href="./browse.html">Browse</a>
      <a href="./collection.html">Collection</a>
      <a href="./upload.html">Upload</a>
      <a href="./about.html">About</a>
    </nav>
  </header>

  <main class="wrap">
    <h1>Collections</h1>
    <p class="small">Auto-grouped by course code (from <code>meta</code>, or inferred from title/file).</p>

    <div id="collections" class="grid"></div>
    <div id="err" class="notice hidden" style="margin-top:14px"></div>
  </main>

  <footer>
    <div>Made with ❤️ · ExamArchive</div>
  </footer>

  <script>
    const TRY_PATHS = ['./papers/papers.json','./papers/index.json','./papers.json'];
    const container = document.getElementById('collections');
    const errEl = document.getElementById('err');

    async function loadPapers(){
      for(const p of TRY_PATHS){
        try {
          const r = await fetch(p, { cache: 'no-store' });
          if(!r.ok) { console.warn('not ok', p, r.status); continue; }
          const data = await r.json();
          return Array.isArray(data) ? data : (data.papers || []);
        } catch (err) {
          console.warn('error fetch', p, err);
        }
      }
      throw new Error('Could not find papers JSON at: ' + TRY_PATHS.join(', '));
    }

    function inferKey(p){
      // prefer meta first token (before '·'), else title before '—', else filename pattern YEAR-COURSE.pdf
      if(p.meta){
        const first = (p.meta.split('·')[0] || '').trim();
        if(first) return first;
      }
      if(p.title){
        const t = (p.title.split('—')[0] || '').trim();
        if(t) return t;
      }
      if(p.file){
        // try match 2023-PHSHCC-201T.pdf or PHSHCC-201T.pdf
        const m = p.file.match(/\b(19|20)\d{2}-([A-Z0-9-]+)\.pdf$/i);
        if(m && m[2]) return m[2];
        const m2 = p.file.match(/([A-Z]{3,}[A-Z0-9-]*\d*T)\.pdf/i);
        if(m2 && m2[1]) return m2[1];
      }
      return 'Others';
    }

    (async function init(){
      try {
        const papers = await loadPapers();
        if(!papers || papers.length === 0){
          container.innerHTML = '<div class="small">No papers available.</div>';
          return;
        }
        // group
        const groups = {};
        for(const p of papers){
          const key = inferKey(p);
          groups[key] = groups[key] || [];
          groups[key].push(p);
        }
        // render
        const html = Object.entries(groups).map(([code, list]) => `
          <section class="collection-card">
            <h3>${escapeHtml(code)}</h3>
            <div class="small">${list.length} paper(s)</div>
            <div style="margin-top:10px"><a class="small" href="browse.html?q=${encodeURIComponent(code)}">Open collection →</a></div>
          </section>
        `).join('');
        container.innerHTML = html;
      } catch (err) {
        console.error(err);
        errEl.classList.remove('hidden');
        errEl.textContent = 'Could not load papers JSON. Check console and verify path (try ./papers/papers.json).';
      }
    })();

    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"'`=\/]/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch]);
    }
  </script>
</body>
</html>